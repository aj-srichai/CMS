<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quotation - PDF Perfect Final</title>
    
    <link href="https://cdn.jsdelivr.net/npm/tom-select@2.2.2/dist/css/tom-select.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/tom-select@2.2.2/dist/js/tom-select.complete.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;500;600;700&display=swap" rel="stylesheet">

    <style>
        * { box-sizing: border-box; }
        
        body { 
            background: #525659; 
            font-family: 'Sarabun', sans-serif; 
            margin: 0;
            padding-top: 80px;
            display: flex;
            justify-content: center;
            align-items: flex-start;
        }

        /* Toolbar */
        .toolbar {
            position: fixed; top: 0; left: 0; right: 0; height: 70px;
            background: white; box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            display: flex; align-items: center; justify-content: center; gap: 15px;
            z-index: 1000; padding: 0 20px;
        }
        .search-wrapper {
            background: #fffbeb; border: 2px solid #d4af37;
            padding: 5px 15px; border-radius: 10px;
            display: flex; align-items: center; gap: 10px;
            box-shadow: 0 4px 6px rgba(212, 175, 55, 0.15);
        }
        .btn-action {
            background: #10b981; color: white; border: none; padding: 10px 20px;
            border-radius: 6px; font-weight: bold; cursor: pointer; 
            display: flex; align-items: center; gap: 8px;
        }
        .btn-action:hover { background: #059669; }
        .btn-new { background: #6366f1; }
        .btn-new:hover { background: #4f46e5; }
        .btn-back { background: transparent; color: #64748b; border: 1px solid #cbd5e1; }
        .btn-back:hover { background: #f1f5f9; }

        .ts-control { border: 1px solid #d4af37 !important; color: #78350f; font-weight: bold; }

        /* ✅ Wrapper: ปกติให้จัดกลาง แต่ตอนปริ้นท์เราจะคุมด้วย JS อีกที */
        #paper-wrapper {
            width: 210mm;
            margin: 0 auto 50px auto;
            position: relative;
            transition: all 0.3s; /* ใส่ Effect ให้ดูนุ่มนวลตอนดีดไปซ้าย */
        }

        /* ✅ A4 Paper */
        #invoice-paper {
            background: white; 
            width: 210mm; 
            min-height: 297mm;
            padding: 10mm 12mm;
            box-shadow: 0 0 15px rgba(0,0,0,0.3);
            color: #000; 
            font-size: 10.5pt; 
            line-height: 1.15;
            position: relative;
            margin: 0;
        }

        /* Table Layout */
        table.layout-table { width: 100%; border-collapse: collapse; margin-bottom: 4px; }
        table.layout-table td { vertical-align: top; padding: 1px 0; }
        
        /* Input Style */
        input.paper-input, textarea.paper-input {
            border: 1px dashed #cbd5e1; 
            background: #fffef8 !important;
            font-family: 'Sarabun', sans-serif; 
            font-size: 10pt; 
            color: #000 !important;
            font-weight: 600;
            padding: 2px 5px; 
            width: 100%; 
            border-radius: 0; 
            resize: none; 
            overflow: hidden;
        }
        input.paper-input:focus { 
            border: 1px solid #d4af37; 
            background: #fffce0 !important;
            outline: none; 
        }
        
        /* สีเฉพาะ input บนหน้าเว็บ */
        #inpProjectName { color: #0f766e !important; font-weight: bold; }
        #inpDisc { color: #d4af37 !important; font-weight: bold; }

        input.text-right { text-align: right; }
        input.text-center { text-align: center; }
        input.font-bold { font-weight: bold; }
        
        input.input-discount {
            border-bottom: 2px solid #666 !important;
            color: #d4af37 !important;
            font-weight: 700 !important;
        }

        .logo-img { height: 42px; margin-right: 8px; }

        /* Data Table */
        table.data-table { 
            width: 100%; border-collapse: collapse; margin-top: 5px;
        }
        table.data-table th { 
            border: 1px solid #000; background: #e5e7eb; 
            padding: 4px; font-size: 9.5pt; text-align: center; 
        }
        table.data-table td { 
            border: 1px solid #000; padding: 4px; 
            vertical-align: top; font-size: 9.5pt; 
        }

        .customer-box {
            border: 1px solid #000; padding: 6px; margin-bottom: 6px;
        }

        /* --- [NEW] Sign Modal Styles --- */
        .modal-overlay {
            display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.5); z-index: 2000;
            justify-content: center; align-items: center;
            backdrop-filter: blur(5px);
        }
        .modal-content {
            background: white; padding: 30px; border-radius: 16px;
            box-shadow: 0 20px 50px rgba(0,0,0,0.3); text-align: center;
            width: 90%; max-width: 450px;
            animation: popUp 0.3s ease-out;
        }
        @keyframes popUp { from { transform: scale(0.8); opacity: 0; } to { transform: scale(1); opacity: 1; } }

        /* ✅ Print / PDF Mode */
        @media print {
            @page { size: A4; margin: 0; }
            body, html { margin: 0; padding: 0; background: white; }
            .toolbar, .modal-overlay { display: none !important; }
            #paper-wrapper { width: 100%; margin: 0; padding: 0; }
            #invoice-paper { 
                width: 210mm; min-height: 297mm; 
                margin: 0; padding: 10mm 12mm; 
                box-shadow: none; border: none; 
            }
        }
    </style>
</head>
<body>

    <div class="toolbar">
        <div class="search-wrapper">
            <span style="font-weight:800; color:#92400e;">
                <i class="fas fa-search" style="color:#d4af37;"></i> ค้นหาลูกค้า:
            </span>
            <div style="width:300px;"><select id="selCustomer"></select></div>
        </div>
        <div style="width:1px; height:30px; background:#ddd; margin:0 15px;"></div>
        <button class="btn-action btn-new" onclick="clearCustomer()">
            <i class="fas fa-user-plus"></i> ล้างข้อมูล
        </button>
        <button class="btn-action" onclick="openSignModal()">
            <i class="fas fa-save"></i> บันทึก & สร้าง PDF
        </button>
        <a href="index.html" class="btn-action btn-back" style="text-decoration:none;">
            <i class="fas fa-times"></i> กลับหน้าหลัก
        </a>
    </div>

    <div id="signModal" class="modal-overlay">
        <div class="modal-content">
            <h3 style="margin-top:0; color:#0f3d33;">✍️ ลงนามผู้จัดทำ (Prepared By)</h3>
            <p style="color:#666; font-size:0.9rem;">กรุณาเซ็นชื่อเพื่อยืนยันการสร้างใบเสนอราคา</p>
            
            <div style="border: 2px dashed #cbd5e1; border-radius: 12px; background: #f8fafc; margin: 15px 0; position: relative;">
                <canvas id="canvasPrepared" width="380" height="200" style="width:100%; touch-action:none; cursor: crosshair;"></canvas>
                <div style="position:absolute; bottom:5px; left:0; width:100%; text-align:center; color:#ccc; font-size:0.8rem; pointer-events:none;">เซ็นชื่อที่นี่</div>
            </div>

            <div style="display: flex; gap: 10px;">
                <button onclick="clearPreparedSign()" class="btn-action" style="background:#f1f5f9; color:#333; flex:1; justify-content:center;">ล้าง</button>
                <button onclick="closeSignModal()" class="btn-action" style="background:#f1f5f9; color:#333; flex:1; justify-content:center;">ยกเลิก</button>
            </div>
            <button onclick="confirmSave()" class="btn-action" style="width:100%; margin-top:10px; justify-content: center; background: linear-gradient(135deg, #0f766e, #115e59);">
                <i class="fas fa-check-circle"></i> ยืนยันและบันทึก
            </button>
        </div>
    </div>

    <div id="paper-wrapper">
        <div id="invoice-paper">
            
            <table class="layout-table">
                <tr>
                    <td style="width: 60%;">
                        <div style="display:flex; align-items:center; margin-bottom:4px;">
                            <img src="cpf-logo.png" class="logo-img" onerror="this.style.display='none'">
                            <img src="techvista.png" class="logo-img" onerror="this.style.display='none'">
                        </div>
                        <div style="font-weight:bold; font-size:10.5pt;">บริษัท ซีพีเอฟ (ประเทศไทย) จำกัด (มหาชน)</div>
                        <div style="font-size:9pt; font-weight:bold;">CPF (Thailand) Public Company Limited</div>
                        <div style="font-size:8.5pt; line-height:1.25;">
                            57 หมู่ที่ 5 ถนนพหลโยธิน ตำบลหนองไข่น้ำ อำเภอหนองแค<br>
                            จังหวัดสระบุรี 18140 (สำนักงานใหญ่)<br>
                            เลขประจำตัวผู้เสียภาษี (Tax ID): 0107555000023
                        </div>
                    </td>
                    <td style="width: 40%; text-align: right; vertical-align: top;">
                        <div style="font-size:17pt; font-weight:bold;">QUOTATION</div>
                        <div style="font-size:11pt; font-weight:bold; margin-bottom:8px;">ใบเสนอราคา</div>
                        
                        <table style="width:100%; font-size:9.5pt;">
                            <tr>
                                <td style="text-align:left; font-weight:bold; padding:2px 0;">Date / วันที่:</td>
                                <td style="padding:2px 0;">
                                    <input type="date" id="inpDate" class="paper-input text-right">
                                </td>
                            </tr>
                            <tr>
                                <td style="text-align:left; font-weight:bold; padding:2px 0;">Quotation No.:</td>
                                <td style="padding:2px 0;">
                                    <input type="text" id="inpQuoteNo" class="paper-input text-right font-bold" placeholder="QT-XXXX">
                                </td>
                            </tr>
                            <tr>
                                <td style="text-align:left; font-weight:bold; padding:2px 0;">Ref ID:</td>
                                <td style="text-align:right; padding:2px 0;">
                                    <span id="sysRefID" style="color:#888;">-</span>
                                </td>
                            </tr>
                        </table>
                    </td>
                </tr>
            </table>

            <div class="customer-box">
                <table class="layout-table" style="font-size:9.5pt; margin:0;">
                    <tr>
                        <td colspan="2" style="font-weight:bold; text-decoration:underline; padding-bottom:3px;">
                            Quotation to / ผู้รับใบเสนอราคา:
                        </td>
                    </tr>
                    <tr>
                        <td style="width: 15%; font-weight:bold; padding:1px 0;">Name:</td>
                        <td style="width: 85%; padding:1px 0;">
                            <input type="text" id="inpContactName" class="paper-input" placeholder="ชื่อ-นามสกุล ผู้ติดต่อ...">
                        </td>
                    </tr>
                    <tr>
                        <td style="font-weight:bold; padding:1px 0;">Company:</td>
                        <td style="padding:1px 0;">
                            <input type="text" id="inpCusName" class="paper-input" placeholder="ชื่อบริษัท...">
                        </td>
                    </tr>
                    <tr>
                        <td style="font-weight:bold; padding:1px 0;">Address:</td>
                        <td style="padding:1px 0;">
                            <input type="text" id="inpCusAddr" class="paper-input" placeholder="ที่อยู่...">
                        </td>
                    </tr>
                    <tr>
                        <td style="font-weight:bold; padding:1px 0;">Phone:</td>
                        <td style="padding:1px 0;">
                            <div style="display:flex; gap:8px; align-items:center;">
                                <input type="text" id="inpCusPhone" class="paper-input" placeholder="เบอร์โทร..." style="flex:1;">
                                <span style="font-weight:bold; white-space:nowrap;">E-mail:</span>
                                <input type="text" id="inpCusEmail" class="paper-input" placeholder="อีเมล..." style="flex:1;">
                            </div>
                        </td>
                    </tr>
                    <tr>
                        <td style="font-weight:bold; padding:1px 0;">Tax ID No.:</td>
                        <td style="padding:1px 0;">
                            <input type="text" id="inpCusTax" class="paper-input" placeholder="เลขประจำตัวผู้เสียภาษี...">
                        </td>
                    </tr>
                </table>
            </div>

            <table class="data-table">
                <thead>
                    <tr>
                        <th style="width:8%">No.</th>
                        <th style="width:50%">Description / รายละเอียด</th>
                        <th style="width:15%">Unit Price</th>
                        <th style="width:10%">Qty</th>
                        <th style="width:17%">Amount (THB)</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td style="text-align:center;">1</td>
                        <td>
                            <input type="text" class="paper-input font-bold" 
                                   value="ค่าบริการที่ปรึกษาโครงการก่อสร้างครบวงจร" 
                                   style="font-size:9.5pt;">
                            <div style="display:flex; align-items:center; gap:5px; font-size:8.5pt; margin-top:2px;">
                                <span style="white-space:nowrap;">Project:</span>
                                <input type="text" id="inpProjectName" class="paper-input" 
                                       placeholder="ระบุชื่อโครงการ..." 
                                       style="font-size:9pt;">
                            </div>
                            <div style="margin-top:2px; font-size:8.5pt; color:#444;">
                                * From Construction Cost: 
                                <input type="number" id="inpCost" class="paper-input text-center" 
                                       style="width:75px; display:inline-block; font-size:9pt;" 
                                       placeholder="0" oninput="calc()"> THB
                            </div>
                            <div style="font-size:8.5pt; color:#444;">
                                * Fee Rate: 
                                <input type="number" id="inpRate" class="paper-input text-center" 
                                       style="width:35px; display:inline-block; font-size:9pt;" 
                                       value="3" oninput="calc()"> %
                            </div>
                        </td>
                        <td style="text-align:right;"><span id="outUnitPrice">0.00</span></td>
                        <td style="text-align:center;">1</td>
                        <td style="text-align:right; font-weight:bold;"><span id="outAmount">0.00</span></td>
                    </tr>
                    <tr>
                        <td colspan="5" style="height: 180px; border:1px solid #000; border-top:none;">&nbsp;</td>
                    </tr>
                </tbody>
            </table>

            <table class="layout-table" style="margin-top:6px;">
                <tr>
                    <td style="width: 58%; vertical-align: top; padding-right:10px;">
                        <div style="border:1px solid #ccc; padding:8px; font-size:8.5pt; height:100%;">
                            <b>Terms and Conditions:</b>
                            <ol style="padding-left: 18px; margin: 4px 0; line-height:1.3;">
                                <li>Please specify the delivery location in advance.<br>(โปรดแจ้งสถานที่จัดส่งล่วงหน้า)</li>
                                <li>Payment Terms: 30 Days Credit.<br>(เครดิตการชำระเงิน 30 วัน)</li>
                                <li>Delivery within 30 days after receiving PO.<br>(ส่งมอบภายใน 30 วันหลังได้รับใบสั่งซื้อ)</li>
                            </ol>
                        </div>
                    </td>
                    <td style="width: 42%; vertical-align: top;">
                        <table style="width:100%; font-size:9.5pt; border-collapse:collapse;">
                            <tr>
                                <td style="padding:2px 5px;">Subtotal:</td>
                                <td style="text-align:right; font-weight:bold; padding:2px 5px;">
                                    <span id="valSubtotal">0.00</span>
                                </td>
                            </tr>
                            <tr>
                                <td style="padding:2px 5px;">
                                    Discount (<input type="number" id="inpDisc" 
                                                     class="paper-input text-center input-discount" 
                                                     style="width:50px; display:inline-block; font-size:10pt;" 
                                                     value="0" oninput="calc()">%):
                                </td>
                                <td style="text-align:right; padding:2px 5px;">
                                    <span id="valDiscount">0.00</span>
                                </td>
                            </tr>
                            <tr>
                                <td style="padding:2px 5px;">After Discount:</td>
                                <td style="text-align:right; padding:2px 5px;">
                                    <span id="valAfterDisc">0.00</span>
                                </td>
                            </tr>
                            <tr>
                                <td style="padding:2px 5px;">VAT 7%:</td>
                                <td style="text-align:right; padding:2px 5px;">
                                    <span id="valVat">0.00</span>
                                </td>
                            </tr>
                            <tr style="background:#f3f4f6; border-top:1px solid #000; border-bottom:3px double #000;">
                                <td style="padding:5px; font-weight:bold;">Grand Total:</td>
                                <td style="padding:5px; text-align:right; font-weight:bold; font-size:10.5pt;">
                                    <span id="valGrandTotal">0.00</span>
                                </td>
                            </tr>
                        </table>
                    </td>
                </tr>
            </table>

            <table class="layout-table" style="margin-top:20px; text-align:center; font-size:9.5pt;">
                <tr>
                    <td style="width:33%; vertical-align: bottom;">
                        <div style="height: 60px; display: flex; align-items: flex-end; justify-content: center;">
                            <img id="showSignPrepared" style="max-height: 50px; max-width: 100%; display: none;">
                        </div>
                        <div style="border-bottom:1px solid #000; width:80%; margin: 5px auto;"></div>
                        <b>Prepared By</b><br>
                        <span style="font-size:8.5pt;">(ผู้จัดทำ)</span><br>
                        <span style="font-size:8.5pt;">Date: <span id="datePrepared"></span></span>
                    </td>

                    <td style="width:33%; vertical-align: bottom;">
                        <div style="height: 60px; display: flex; align-items: flex-end; justify-content: center;">
                            <img id="showSignReview" style="max-height: 50px; max-width: 100%; display: none;">
                        </div>
                        <div style="border-bottom:1px solid #000; width:80%; margin: 5px auto;"></div>
                        <b>Reviewed By</b><br>
                        <span style="font-size:8.5pt;">(ผู้ตรวจสอบ)</span><br>
                        <span style="font-size:8.5pt;">Date: <span id="dateReviewed">____/____/______</span></span>
                    </td>

                    <td style="width:33%; vertical-align: bottom;">
                        <div style="height: 60px; display: flex; align-items: flex-end; justify-content: center;">
                            <img id="showSignCustomer" style="max-height: 50px; max-width: 100%; display: none;">
                        </div>
                        <div style="border-bottom:1px solid #000; width:80%; margin: 5px auto;"></div>
                        <b>Accepted By</b><br>
                        <span style="font-size:8.5pt;">(ลูกค้า/ผู้อนุมัติ)</span><br>
                        <span style="font-size:8.5pt;">Date: <span id="dateCustomer">____/____/______</span></span>
                    </td>
                </tr>
            </table>

        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/signature_pad@4.0.0/dist/signature_pad.umd.min.js"></script>
    
    <script type="module">
        import * as config from './config.js';
        import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/+esm';

        const supabaseApp = createClient(config.SUPABASE_URL, config.SUPABASE_ANON_KEY);
        let tomSelect;
        let customerData = [];
        let padPrepared = null; 

        // เช็คโหมด
        const urlParams = new URLSearchParams(window.location.search);
        const isInternal = urlParams.get('mode') === 'internal';
        const paramId = urlParams.get('id'); // รับ ID มาเพื่อเปิดดู/พิมพ์
        const isPrintMode = urlParams.get('mode') === 'print';

        document.addEventListener('DOMContentLoaded', async () => {
            // โหลดข้อมูลถ้ามี ID
            if (paramId) {
                await loadExistingQuotation(paramId);
            } else {
                await setupNewQuotation();
            }

            // ถ้าเป็นโหมด Print ให้สั่งพิมพ์อัตโนมัติ
            if (isPrintMode) {
                setTimeout(() => window.print(), 1000);
            }
            calc();
        });

        // ฟังก์ชันเปิด Modal เซ็นชื่อ (แทนที่จะโชว์คาไว้ที่ Toolbar)
        window.openSignModal = function() {
            let projName = document.getElementById('inpProjectName').value;
            const cusName = document.getElementById('inpCusName').value;
            
            if(!projName || !cusName) { 
                Swal.fire('ข้อมูลไม่ครบ', 'ระบุชื่อลูกค้าและชื่อโครงการ', 'warning'); return; 
            }

            document.getElementById('signModal').style.display = 'flex';
            
            // Init Pad ถ้ายังไม่เคยสร้าง (ต้องรอ Modal แสดงก่อน Canvas ถึงจะมีขนาดจริง)
            if (!padPrepared) {
                const canvas = document.getElementById('canvasPrepared');
                const ratio = Math.max(window.devicePixelRatio || 1, 1);
                canvas.width = canvas.offsetWidth * ratio;
                canvas.height = canvas.offsetHeight * ratio;
                canvas.getContext("2d").scale(ratio, ratio);
                padPrepared = new SignaturePad(canvas, { backgroundColor: 'rgba(255,255,255,0)', penColor:'rgb(0,0,0)' });
            }
        };

        window.closeSignModal = function() {
            document.getElementById('signModal').style.display = 'none';
        };

        window.clearPreparedSign = function() {
            if (padPrepared) padPrepared.clear();
        };

        // กดปุ่มยืนยันใน Modal -> ทำงานบันทึกจริง
        window.confirmSave = function() {
            if (!padPrepared || padPrepared.isEmpty()) {
                Swal.fire('แจ้งเตือน', 'กรุณาเซ็นชื่อก่อนบันทึก', 'warning');
                return;
            }
            closeSignModal();
            executeSave();
        };

        async function setupNewQuotation() {
            document.getElementById('inpDate').valueAsDate = new Date();
            document.getElementById('datePrepared').innerText = new Date().toLocaleDateString('th-TH');

            const { count } = await supabaseApp.from(config.PROJECT_TABLE).select('*', { count: 'exact', head: true });
            const nextId = (count || 0) + 1;
            document.getElementById('sysRefID').innerText = `#${nextId}`;
            
            const year = new Date().getFullYear();
            document.getElementById('inpQuoteNo').value = `QT-${year}-${String(nextId).padStart(4,'0')}`;

            await loadCustomers();
        }

        async function loadExistingQuotation(id) {
            const { data: proj, error } = await supabaseApp.from(config.PROJECT_TABLE).select('*').eq('id', id).single();
            if (error || !proj) {
                Swal.fire('Error', 'ไม่พบข้อมูลใบเสนอราคา', 'error');
                return;
            }

            // เติมข้อมูลลง Input
            document.getElementById('inpProjectName').value = proj.projectName || '';
            document.getElementById('valGrandTotal').innerText = (proj.budget || 0).toLocaleString('th-TH', {minimumFractionDigits:2});
            
            // 1. ผู้จัดทำ
            if (proj.prepared_sign) {
                document.getElementById('showSignPrepared').src = proj.prepared_sign;
                document.getElementById('showSignPrepared').style.display = 'block';
                if(proj.created_at) {
                    const d = new Date(proj.created_at);
                    document.getElementById('datePrepared').innerText = d.toLocaleDateString('th-TH');
                }
            }

            // 2. ผู้ตรวจสอบ
            if (proj.approver_sign) {
                document.getElementById('showSignReview').src = proj.approver_sign;
                document.getElementById('showSignReview').style.display = 'block';
                if(proj.approved_at) {
                    const d = new Date(proj.approved_at);
                    document.getElementById('dateReviewed').innerText = d.toLocaleDateString('th-TH');
                }
            }

            // 3. ลูกค้า
            if (proj.customer_sign) {
                document.getElementById('showSignCustomer').src = proj.customer_sign;
                document.getElementById('showSignCustomer').style.display = 'block';
            }
            
            // ดึงข้อมูลลูกค้า
            if(proj.location_id) {
                 const { data: loc } = await supabaseApp.from(config.LOCATION_TABLE).select('*').eq('id', proj.location_id).single();
                 if(loc) {
                     document.getElementById('inpCusName').value = loc.site_name;
                     document.getElementById('inpCusAddr').value = loc.address || '';
                     document.getElementById('inpCusTax').value = loc.tax_id || '';
                 }
            }
        }

        async function loadCustomers() {
            const { data } = await supabaseApp.from(config.LOCATION_TABLE).select('*');
            customerData = data || [];
            const selectEl = document.getElementById('selCustomer');
            if (selectEl && !tomSelect) {
                tomSelect = new TomSelect('#selCustomer', {
                    options: customerData.map(c => ({
                        value: c.id, text: c.site_name, address: c.address || '', tax_id: c.tax_id || ''
                    })),
                    valueField: 'value', labelField: 'text', searchField: ['text', 'address'],
                    placeholder: 'พิมพ์ชื่อบริษัท...', maxOptions: 50,
                    onChange: (val) => {
                        const found = customerData.find(c => c.id == val);
                        if(found) {
                            document.getElementById('inpCusName').value = found.site_name || '';
                            document.getElementById('inpCusAddr').value = found.address || '';
                            document.getElementById('inpCusTax').value = found.tax_id || '';
                        }
                    }
                });
            }
        }

        window.calc = () => {
            const cost = parseFloat(document.getElementById('inpCost').value) || 0;
            const rate = parseFloat(document.getElementById('inpRate').value) || 0;
            const discP = parseFloat(document.getElementById('inpDisc').value) || 0;
            const fee = cost * (rate / 100);
            const discount = fee * (discP / 100);
            const afterDisc = fee - discount;
            const vat = afterDisc * 0.07;
            const total = afterDisc + vat;
            
            const fmt = (n) => n.toLocaleString(undefined, {minimumFractionDigits:2, maximumFractionDigits:2});
            document.getElementById('outUnitPrice').innerText = fmt(fee);
            document.getElementById('outAmount').innerText = fmt(fee);
            document.getElementById('valSubtotal').innerText = fmt(fee);
            document.getElementById('valDiscount').innerText = fmt(discount);
            document.getElementById('valAfterDisc').innerText = fmt(afterDisc);
            document.getElementById('valVat').innerText = fmt(vat);
            document.getElementById('valGrandTotal').innerText = fmt(total);
        };

        // ฟังก์ชันบันทึกจริง (แยกออกมาเรียกหลัง Modal)
        async function executeSave() {
            let projName = document.getElementById('inpProjectName').value;
            const cusName = document.getElementById('inpCusName').value;
            const grandTotal = parseFloat(document.getElementById('valGrandTotal').innerText.replace(/,/g, ''));

            if (isInternal && !projName.includes('(กรอกแทน)')) {
                projName += ' (กรอกแทน)';
                document.getElementById('inpProjectName').value = projName;
            }
            
            // เก็บ Signature จาก Modal
            let preparedSignData = null;
            if (padPrepared && !padPrepared.isEmpty()) {
                preparedSignData = padPrepared.toDataURL();
                // แปะลงกระดาษเพื่อ Gen PDF
                document.getElementById('showSignPrepared').src = preparedSignData;
                document.getElementById('showSignPrepared').style.display = 'block';
            }

            Swal.fire({ title: 'กำลังบันทึก...', allowOutsideClick: false, didOpen: () => Swal.showLoading() });

            try {
                let locId = tomSelect ? tomSelect.getValue() : null;
                if(!locId) {
                    const { data: newLoc, error: locErr } = await supabaseApp.from(config.LOCATION_TABLE)
                        .insert([{ site_name: cusName, address: document.getElementById('inpCusAddr').value, tax_id: document.getElementById('inpCusTax').value }]).select().single();
                    if(locErr) throw new Error(locErr.message);
                    locId = newLoc.id;
                }

                const wrapper = document.getElementById('paper-wrapper');
                const invoice = document.getElementById('invoice-paper');
                const oldWrapperStyle = wrapper.style.cssText;
                
                wrapper.style.margin = '0'; wrapper.style.width = 'fit-content';
                invoice.style.margin = '0'; invoice.style.boxShadow = 'none';
                
                const inputs = document.querySelectorAll('.paper-input');
                const originalStyles = new Map();
                inputs.forEach(input => {
                    originalStyles.set(input, { border: input.style.border, background: input.style.background });
                    input.style.border = 'none'; input.style.background = 'white';
                });

                const opt = {
                    margin: 0, filename: `Quotation-${projName}.pdf`,
                    image: { type: 'jpeg', quality: 0.98 },
                    html2canvas: { scale: 2, useCORS: true, logging: false },
                    jsPDF: { unit: 'mm', format: 'a4', orientation: 'portrait' }
                };
                
                const pdfBlob = await html2pdf().set(opt).from(invoice).outputPdf('blob');

                wrapper.style.cssText = oldWrapperStyle;
                invoice.style.boxShadow = '';
                inputs.forEach(input => {
                    const s = originalStyles.get(input);
                    input.style.border = s.border; input.style.background = s.background;
                });

                const fileName = `QT_${Date.now()}.pdf`;
                await supabaseApp.storage.from(config.BUCKET_NAME).upload(`quotations/${fileName}`, pdfBlob);
                const { data: urlData } = supabaseApp.storage.from(config.BUCKET_NAME).getPublicUrl(`quotations/${fileName}`);

                const { error: insertError } = await supabaseApp.from(config.PROJECT_TABLE).insert([{
                projectName: projName, 
                location_id: locId, 
                budget: grandTotal, 
                status: 'wait_for_approval', 
                quotationPDF: urlData.publicUrl, 
                constructionType: 'โครงการก่อร้างใหม่',
                prepared_sign: preparedSignData,
                prepared_by: 'Admin/Staff', 
                created_at: new Date().toISOString()
            }]);

            if (insertError) throw new Error("Database Insert Failed: " + insertError.message);

            Swal.fire('สำเร็จ!', 'บันทึกและส่งรออนุมัติเรียบร้อย', 'success').then(() => {
                window.location.href = isInternal ? 'admin.html' : 'index.html';
            });

            } catch (err) {
                console.error(err);
                Swal.fire('Error', err.message, 'error');
            }
        }
    </script>
</body>
</html>